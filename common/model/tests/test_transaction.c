/*
 * Copyright (c) 2018 IOTA Stiftung
 * https://github.com/iotaledger/entangled
 *
 * Refer to the LICENSE file for licensing information
 */

#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <unity/unity.h>

#include "common/model/transaction.h"
#include "common/trinary/tryte.h"

static tryte_t tx_trytes[] =
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999999999999999999999999999999999999"
    "99999999999999999999999999999999999999999OZCTDHTFCB9PTAZWGYCGOA9XKDKPSHWVS"
    "ZDJKZCOINNQTPNNEANGPBBDLSNGKDGCAAKBDVBOVCPTRLHTANBQWWHA9999999999999999999"
    "9QB9999999999999999999999999NIDXNZD99999999999C99999999TGVLSHLVOBDJSABFCAY"
    "HWXPVLITRFWXJRKJVZACJKPAKRQIOUV9XZIJYJO9ZBHA9BRXE9IGDZADBBNQWBUOUPJKGMHLFP"
    "VLRWJXLFVPW9QOMP9NJDSRCIMYHYQ9T9BBWPMCYPBGPGTGHNSDSVHIXOASHZMLJZA9999NFOAK"
    "XCYLXKBLIGKUVXLLYELKHJBDYNCIOZBSTI9YSKDFZEKNQJTJUUPQGGXYLE9TCXOOQGBSXHKA99"
    "99999999999999999999999999999KDOWQ9CKE999999999MMMMMMMMMTI99999999F9J99999"
    "999999999";

int main(void) {
  UNITY_BEGIN();

  trit_t tx_trits[NUM_TRITS_SERIALIZED_TRANSACTION];
  flex_trit_t tx_flex_trits[FLEX_TRIT_SIZE_8019];
  byte_t tx_bytes[min_bytes(NUM_TRITS_SERIALIZED_TRANSACTION)];
  trit_t hash_trits[NUM_TRITS_HASH];
  byte_t hash_bytes[min_bytes(NUM_TRITS_HASH)];

  trytes_to_trits(tx_trytes, tx_trits, NUM_TRYTES_SERIALIZED_TRANSACTION);
  int8_to_flex_trit_array(tx_flex_trits, FLEX_TRIT_SIZE_8019, tx_trits,
                          NUM_TRITS_SERIALIZED_TRANSACTION,
                          NUM_TRITS_SERIALIZED_TRANSACTION);
  iota_transaction_t tx = transaction_deserialize(tx_flex_trits);
  for (size_t i = 0; i < FLEX_TRIT_SIZE_243; i++) {
    printf("%c", tx->hash[i]);
  }
  printf("\n");
  flex_trit_array_to_int8(hash_trits, NUM_TRITS_HASH, tx->hash, NUM_TRITS_HASH,
                          NUM_TRITS_HASH);

  trits_to_bytes(tx_trits, tx_bytes, NUM_TRITS_SERIALIZED_TRANSACTION);
  trits_to_bytes(hash_trits, hash_bytes, NUM_TRITS_HASH);

  int tx_fd;
  int hash_fd;

  tx_fd = open("tx_bytes", O_CREAT | O_TRUNC | O_RDWR, 0666);
  hash_fd = open("hash_bytes", O_CREAT | O_TRUNC | O_RDWR, 0666);

  write(tx_fd, tx_bytes, 1604);
  write(hash_fd, hash_bytes, 46);
  return UNITY_END();
}
