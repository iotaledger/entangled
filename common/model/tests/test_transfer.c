/*
 * Copyright (c) 2018 IOTA Stiftung
 * https://github.com/iotaledger/entangled
 *
 * Refer to the LICENSE file for licensing information
 */

#include <stdlib.h>
#include <string.h>
#include <unity/unity.h>

#include "common/model/transfer.h"

#if defined(TRIT_ARRAY_ENCODING_1_TRIT_PER_BYTE)
const flex_trit_t ADDRESS[] = {
    0,  0,  0,  0,  -1, 0,  1,  1,  -1, 0,  0,  0,  0,  0,  -1, 1,  0,  1, 1,
    -1, 1,  0,  -1, 1,  1,  0,  1,  1,  0,  1,  -1, 0,  0,  -1, -1, 0,  0, 0,
    1,  -1, 1,  -1, 1,  1,  0,  1,  -1, -1, -1, 1,  1,  1,  0,  -1, -1, 0, -1,
    0,  -1, 0,  0,  0,  -1, -1, 1,  -1, -1, 0,  1,  0,  1,  0,  -1, 1,  1, 1,
    0,  1,  1,  0,  0,  0,  0,  1,  -1, 0,  0,  -1, 0,  0,  1,  -1, 0,  0, 0,
    0,  -1, 1,  0,  1,  -1, 0,  0,  1,  1,  -1, 1,  0,  -1, -1, 1,  -1, 0, -1,
    0,  1,  -1, 0,  -1, 0,  0,  1,  -1, -1, -1, -1, 0,  1,  0,  0,  1,  1, 0,
    0,  1,  -1, 1,  -1, 0,  0,  -1, -1, 0,  -1, 1,  1,  0,  0,  0,  -1, 0, 0,
    0,  0,  1,  0,  0,  1,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  1,  0, 0,
    1,  0,  0,  -1, -1, -1, 1,  1,  1,  0,  -1, 0,  1,  -1, 0,  -1, -1, 1, -1,
    1,  1,  1,  1,  0,  0,  0,  0,  1,  -1, 1,  0,  1,  1,  1,  0,  1,  1, -1,
    1,  1,  1,  -1, -1, 1,  0,  0,  0,  0,  -1, 0,  1,  0,  0,  1,  1,  0, 0,
    1,  -1, 1,  0,  0,  -1, 0,  0,  1,  -1, 1,  0,  -1, 0,  -1,
};
const flex_trit_t TAG[] = {
    -1, 0,  0,  -1, 1,  -1, 1,  1, 0,  0,  0,  1,  1,  1, 0,  -1, -1,
    -1, -1, 0,  -1, 1,  1,  0,  1, 0,  1,  -1, 0,  0,  1, -1, 1,  0,
    1,  -1, -1, 0,  -1, -1, 1,  1, 0,  -1, -1, -1, -1, 0, 1,  0,  1,
    0,  0,  0,  1,  0,  1,  -1, 0, 0,  0,  0,  -1, 0,  1, 0,  -1, 1,
    1,  0,  -1, -1, 1,  1,  -1, 1, -1, 1,  1,  -1, -1,
};
const flex_trit_t HASH[] = {
    -1, -1, -1, 1,  -1, 0,  1,  0,  -1, 1,  0,  1,  1,  0,  -1, -1, -1, 1,  1,
    -1, 1,  0,  1,  0,  -1, -1, 0,  -1, -1, 1,  1,  0,  -1, 1,  1,  0,  1,  0,
    0,  0,  -1, 1,  0,  1,  1,  0,  0,  1,  0,  -1, 1,  0,  1,  0,  -1, -1, -1,
    1,  0,  1,  0,  -1, 1,  -1, -1, 0,  1,  -1, 1,  -1, 0,  0,  0,  0,  0,  1,
    -1, -1, 0,  1,  0,  1,  -1, 0,  1,  1,  0,  0,  -1, -1, -1, 1,  -1, 0,  0,
    0,  1,  1,  -1, 0,  1,  0,  1,  0,  -1, 1,  0,  0,  0,  1,  1,  -1, 1,  1,
    -1, 1,  0,  1,  1,  0,  0,  0,  0,  0,  1,  -1, 0,  1,  -1, -1, -1, -1, -1,
    1,  1,  -1, 1,  0,  1,  0,  1,  1,  0,  0,  1,  0,  1,  0,  1,  0,  -1, 1,
    0,  0,  0,  0,  -1, 1,  1,  1,  1,  -1, 1,  1,  1,  -1, 1,  -1, -1, 0,  1,
    -1, 0,  0,  1,  1,  0,  1,  -1, -1, 0,  0,  -1, 1,  1,  0,  1,  1,  0,  0,
    -1, 0,  0,  1,  0,  0,  0,  0,  0,  1,  -1, 0,  -1, 1,  1,  0,  1,  -1, 0,
    -1, -1, 1,  0,  1,  0,  1,  -1, 1,  0,  -1, 0,  -1, 0,  -1, 1,  0,  1,  -1,
    1,  -1, -1, 1,  0,  1,  -1, 1,  1,  0,  -1, 1,  0,  1,  0,
};
#elif defined(TRIT_ARRAY_ENCODING_3_TRITS_PER_BYTE)
const flex_trit_t ADDRESS[] = {
    57, 88, 86, 57, 82, 74, 71, 70, 74, 74, 90, 87, 73, 84, 68, 80, 75,
    83, 81, 88, 82, 84, 72, 67, 75, 74, 65, 73, 90, 90, 89, 57, 66, 89,
    76, 66, 69, 81, 85, 88, 85, 78, 67, 76, 73, 84, 82, 81, 68, 82, 57,
    67, 67, 68, 57, 57, 65, 65, 78, 77, 88, 89, 69, 75, 68, 57, 71, 76,
    74, 71, 86, 66, 57, 72, 73, 65, 71, 82, 73, 66, 81};
const flex_trit_t TAG[] = {90, 84, 68, 73, 68, 78, 81, 68, 74,
                           90, 71, 85, 81, 75, 79, 87, 74, 57,
                           74, 90, 82, 67, 75, 79, 86, 71, 80};
const flex_trit_t HASH[] = {
    78, 89, 83, 74, 83, 69, 71, 67, 87, 69, 83, 68, 65, 70, 76, 73, 70,
    67, 78, 74, 70, 87, 71, 90, 57, 80, 67, 89, 68, 79, 84, 57, 86, 67,
    83, 65, 76, 75, 66, 68, 57, 85, 85, 78, 75, 66, 74, 65, 74, 67, 66,
    57, 75, 86, 77, 84, 72, 90, 68, 80, 82, 68, 68, 88, 67, 57, 85, 70,
    74, 81, 66, 74, 66, 81, 70, 85, 80, 74, 75, 70, 67};
#elif defined(TRIT_ARRAY_ENCODING_4_TRITS_PER_BYTE)
const flex_trit_t ADDRESS[] = {
    0,  83,  3,  112, -44, 113, 81,  52, 60, -48, 93, -12, 87, 60, 51,  -16,
    61, 17,  87, 20,  64,  -61, -48, 0,  71, 67,  29, -33, 76, 51, -12, 79,
    80, -48, 13, -49, 5,   12,  16,  68, 1,  0,   65, -16, 87, 76, -13, 93,
    5,  -48, 81, 81,  87,  31,  -64, 4,  5,  29,  12, 29,  51,
};
const flex_trit_t TAG[] = {
    -61, 93, 64, -59, 63, 23,  -47, -48, -47, -13, -59,
    63,  17, 16, 13,  48, 113, -15, 117, -41, 3,
};
const flex_trit_t HASH[] = {
    127, 19,  71,  -15, -41, 17,  -49, 23,  23, 1,   71, 65,  28,
    -15, 71,  -36, -45, 13,  64,  79,  52,  5,  127, 3,  53,  17,
    7,   -44, 117, 20,  0,   77,  -1,  -41, 17, 5,   17, 113, 0,
    87,  93,  -35, -45, 80,  -12, 112, 81,  48, 4,   64, 115, -47,
    124, 68,  -57, -52, -47, 125, 116, 113, 4,
};
#elif defined(TRIT_ARRAY_ENCODING_5_TRITS_PER_BYTE)
const flex_trit_t ADDRESS[] = {
    -81, -15, -81, -44, 100, 93, -109, -54, 34,   43,  -104, -30,  45,
    23,  100, 37,  -54, -9,  -2, 87,   107, -106, -29, -29,  -114, 8,
    85,  -7,  50,  -80, 81,  90, 1,    27,  -78,  113, -57,  -66,  40,
    -54, 118, 66,  49,  -81, 84, -53,  -26, 21,   -10,
};
const flex_trit_t TAG[] = {
    53, 11, 39, -40, 92, -6, 88, -112, -104, 23, 82, -6, 72, 33, -49, -47, -1,
};
const flex_trit_t HASH[] = {
    -67, 57, -69, -49, -71,  44,  100, 3,   110, -72, -71, 86, -102,
    -60, 0,  70,  75,  -107, -7,  -15, -71, 82,  -47, 37,  81, -100,
    95,  29, 85,  30,  2,    114, 115, -34, 79,  -98, 99,  12, 26,
    81,  98, -87, 29,  -74,  51,  -60, -52, 58,  3,
};
#endif

void test_bundle_hash(coid) {
  transfer_t transfer = transfer_new(VALUE_IN);
  transfer_value_in_t value_in = transfer_value_in(transfer);
  transfer_value_in_set_address(value_in, (const tryte_t *)ADDRESS);
  transfer_set_tag(transfer, (tryte_t *)TAG);
  transfer_set_timestamp(transfer, 1509136296);

  transfer_t transfers[1] = {transfer};
  Kerl kerl = {};
  init_kerl(&kerl);
  transfer_ctx_t transfer_ctx = transfer_ctx_new();
  transfer_ctx_init(transfer_ctx, transfers, 1);
  transfer_ctx_hash(transfer_ctx, &kerl, transfers, 1);
  tryte_t *bundle_hash = transfer_ctx_finalize(transfer_ctx);
  TEST_ASSERT_EQUAL_MEMORY(HASH, bundle_hash, sizeof(HASH));
  transfer_ctx_free(transfer_ctx);
  transfer_free(transfer);
}

int main(void) {
  UNITY_BEGIN();

  RUN_TEST(test_bundle_hash);

  return UNITY_END();
}
